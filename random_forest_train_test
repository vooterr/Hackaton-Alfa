import pandas as pd
import numpy as np
from sklearn.ensemble import RandomForestRegressor
from sklearn.metrics import mean_absolute_error

def wmae(y_true, y_pred):
    return np.mean(np.abs(y_true - y_pred))

print("Загрузка данных...")
train = pd.read_csv('hackathon_income_train_imputed.csv')
test = pd.read_csv('hackathon_income_test_imputed.csv')

print(f"Train: {train.shape}, Test: {test.shape}")

X_train = train.drop(columns=['target'])
y_train = train['target']
X_test = test

common_cols = X_train.columns.intersection(X_test.columns)
X_train = X_train[common_cols]
X_test = X_test[common_cols]

print(f"После выравнивания: Train {X_train.shape}, Test {X_test.shape}")

print("Обучение Random Forest...")
rf = RandomForestRegressor(
    n_estimators=100,
    random_state=42,
    n_jobs=-1,
    max_depth=10
)

rf.fit(X_train.values, y_train.values)

y_pred_train = rf.predict(X_train.values)
test_predictions = rf.predict(X_test.values)
train_wmae = wmae(y_train, y_pred_train)
train_mae = mean_absolute_error(y_train, y_pred_train)

print(f"WMAE: {train_wmae:.2f}")
print(f"MAE: {train_mae:.2f}")

predictions_per_tree = np.array([tree.predict(X_test) for tree in rf.estimators_])
confidence_scores = np.std(predictions_per_tree, axis=0)

print(f"\nCONFIDENCE SCORE (на тестовых данных):")
print(f"Среднее: {confidence_scores.mean():.2f}")
print(f"Медиана: {np.median(confidence_scores):.2f}")
print(f"Min: {confidence_scores.min():.2f}")
print(f"Max: {confidence_scores.max():.2f}")

print("\nСоздание предсказаний...")
test_predictions = rf.predict(X_test)

submission = pd.DataFrame({
    'id': test['id'] if 'id' in test.columns else test.index,
    'target': test_predictions
})

submission_file = 'random_forest_predictions.csv'
submission.to_csv(submission_file, index=False)

print(f"\nФайл с предсказаниями сохранен как: {submission_file}")
print(f"Размер файла: {submission.shape}")
print(f"Пример предсказаний:\n{submission.head(10)}")

print(f"\nСТАТИСТИКА ПРЕДСКАЗАНИЙ:")
print(f"Min: {test_predictions.min():.2f}")
print(f"Max: {test_predictions.max():.2f}")
print(f"Mean: {test_predictions.mean():.2f}")
print(f"Std: {test_predictions.std():.2f}")
